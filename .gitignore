-- Load Rayfield Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Create Window
local Window = Rayfield:CreateWindow({
    Name = "Baddies Crowbar Autofarm",
    LoadingTitle = "Automation Hub",
    LoadingSubtitle = "by kugala4548",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "MyConfigs",
        FileName = "TeleportLoop"
    }
})

-- Create Tab
local MainTab = Window:CreateTab("Main", 4483362458)

-- Services
local Players = game:GetService("Players")
local localPlayer = Players.LocalPlayer
local vim = game:GetService("VirtualInputManager")

-- State
local masterEnabled = true
local running = false
local loopThread
local afkRunning = false
local afkThread
local monitorThread
local teleportDelay = 0.5
local detectionRadius = 150
local targetUsername = ""

-- Teleport target
local targetCFrame = CFrame.new(
    539.335999, -18.8820095, -29.6586018,
    -0.0170790255, -5.78686716e-08, -0.999854147,
    6.68314015e-10, 1, -5.78885277e-08,
    0.999854147, -1.65689618e-09, -0.0170790255
)

-- Helper: Check if player is near target
local function isNearTarget()
    local character = localPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return false end
    return (character.HumanoidRootPart.Position - targetCFrame.Position).Magnitude <= detectionRadius
end

-- Helper: Activate nearby proximity prompt
local function activateNearbyPrompt()
    local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
    local hrp = character:WaitForChild("HumanoidRootPart")

    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA("ProximityPrompt") and obj.Enabled then
            local dist = (obj.Parent.Position - hrp.Position).Magnitude
            if dist < 10 then
                fireproximityprompt(obj)
                break
            end
        end
    end
end

-- Main loop
local function runLoop()
    while running and masterEnabled do
        local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
        local hrp = character:WaitForChild("HumanoidRootPart")

        -- Force teleport until within range
        while not isNearTarget() do
            hrp.CFrame = targetCFrame
            task.wait(0.1)
        end

        -- Final teleport to exact spot
        hrp.CFrame = targetCFrame
        task.wait(teleportDelay)

        -- Activate prompt
        activateNearbyPrompt()

        task.wait(1)
    end
end

-- AFK loop
local function afkLoop()
    while afkRunning do
        local viewport = workspace.CurrentCamera.ViewportSize
        local x, y = viewport.X / 2, viewport.Y / 2
        vim:SendMouseButtonEvent(x, y, 0, true, game, 0)
        vim:SendMouseButtonEvent(x, y, 0, false, game, 0)
        task.wait(60)
    end
end

-- Monitor crowd and toggle autofarm
local function monitorCrowd()
    while true do
        if masterEnabled and targetUsername ~= "" then
            local character = localPlayer.Character
            if not character or not character:FindFirstChild("HumanoidRootPart") then
                task.wait(5)
                continue
            end

            local root = character.HumanoidRootPart
            local targetPlayer = Players:FindFirstChild(targetUsername)
            local targetNearby = false
            local strangerNearby = false

            for _, otherPlayer in pairs(Players:GetPlayers()) do
                if otherPlayer ~= localPlayer and otherPlayer.Character and otherPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    local dist = (root.Position - otherPlayer.Character.HumanoidRootPart.Position).Magnitude
                    if dist <= detectionRadius then
                        if otherPlayer.Name == targetUsername then
                            targetNearby = true
                        else
                            strangerNearby = true
                        end
                    end
                end
            end

            if strangerNearby and running then
                print("Stranger detected. Turning OFF autofarm.")
                running = false
                Rayfield.Flags["TeleportLoop"]:Set(false)
            elseif targetNearby and not strangerNearby and not running then
                print("Target user nearby. Turning ON autofarm.")
                running = true
                Rayfield.Flags["TeleportLoop"]:Set(true)
                loopThread = task.spawn(runLoop)
            elseif (not targetNearby or strangerNearby) and running then
                print("Conditions not met. Turning OFF autofarm.")
                running = false
                Rayfield.Flags["TeleportLoop"]:Set(false)
            end
        end
        task.wait(5)
    end
end

-- GUI Controls
MainTab:CreateInput({
    Name = "Target Username",
    PlaceholderText = "Enter exact username",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        targetUsername = Text
        print("Target user set to:", targetUsername)
    end,
})

MainTab:CreateToggle({
    Name = "Crowbar Autofarm Master Toggle",
    CurrentValue = true,
    Flag = "MasterToggle",
    Callback = function(Value)
        masterEnabled = Value
        if not masterEnabled then
            print("Master toggle OFF. Disabling autofarm and monitor.")
            running = false
            Rayfield.Flags["TeleportLoop"]:Set(false)
        end
    end,
})

MainTab:CreateToggle({
    Name = "Crowbar Autofarm",
    CurrentValue = false,
    Flag = "TeleportLoop",
    Callback = function(Value)
        if masterEnabled then
            running = Value
            if running then
                loopThread = task.spawn(runLoop)
            end
        else
            print("Autofarm blocked: Master toggle is OFF.")
            Rayfield.Flags["TeleportLoop"]:Set(false)
        end
    end,
})

MainTab:CreateSlider({
    Name = "Teleport Speed",
    Range = {0.1, 2},
    Increment = 0.1,
    Suffix = "s",
    CurrentValue = teleportDelay,
    Flag = "TeleportSpeed",
    Callback = function(Value)
        teleportDelay = Value
    end,
})

MainTab:CreateButton({
    Name = "Return to Crowbar Spot",
    Callback = function()
        local character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
        local hrp = character:WaitForChild("HumanoidRootPart")
        hrp.CFrame = targetCFrame
    end,
})

MainTab:CreateToggle({
    Name = "AFK Prevention",
    CurrentValue = false,
    Flag = "AFKPrevention",
    Callback = function(Value)
        afkRunning = Value
        if afkRunning then
            afkThread = task.spawn(afkLoop)
        end
    end,
})

-- Start crowd monitor
monitorThread = task.spawn(monitorCrowd)
